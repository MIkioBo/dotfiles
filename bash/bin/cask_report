#!/usr/bin/env ruby

require 'awesome_print'
require 'colorize'

def report(type)
  latest_sha_file = "#{Dir.home}/.homebrew-#{type}-latest-sha"
  cask_repo = "/usr/local/Library/Taps/caskroom/homebrew-#{type}"
  updated = []
  added   = []
  removed = []

  Dir.chdir cask_repo

  if File.exist?(latest_sha_file)
    old_sha = File.read(latest_sha_file).strip
  else
    old_sha = `git log | head -20 | /usr/bin/tail -r | head -1 | ansifilter`.scan(/([a-z0-9]{7})\s.+/)[0][0]
  end
  latest_sha = `git log --no-color | head -1 | ansifilter`.scan(/([a-z0-9]{7})\s.+/)[0][0]
  File.open(latest_sha_file, 'w') { |file| file.write(latest_sha) }

  installed_casks = `brew cask ls`.split("\n")
  changes = `git diff --stat #{old_sha} | grep Casks`.split("\n")
  apps = changes.map { |c| c.scan(%r{^\s+Casks/(.+)\.rb\s+\|\s+\d+\s([+-]+)$}).first }

  apps.each do |a|
    if a.last.split('').all? { |x| x == '-' }
      removed << a.first.colorize(:light_blue)
    else
      h = `cat Casks/#{a.first}.rb | grep -E '^\s+homepage'`
      homepage = h.empty? ? '' : h.scan(/^\s+homepage\s+["'](.+)["']\s*$/).first.first
      if a.last.split('').all? { |x| x == '+' }
        added << a.first.colorize(:light_blue) + " [#{homepage.colorize(:light_green)}]"
      else
        updated << a.first.colorize(:light_blue) + "#{'âœ¨' if installed_casks.include?(a.first)}" + " [#{homepage.colorize(:light_green)}]"
      end
    end
  end

  puts "ðŸ”®  #{type.upcase}".colorize(:magenta)
  puts "#{'UPDATED'.colorize(:light_magenta)}\n#{updated.join("\n")}" unless updated.empty?
  puts "#{'ADDED'.colorize(:light_magenta)}\n#{added.join("\n")}" unless added.empty?
  puts "#{'REMOVED'.colorize(:light_magenta)}\n#{removed.join("\n")}" unless removed.empty?
  puts "OLD SHA: #{old_sha.colorize(:light_magenta)}  NEW SHA: #{latest_sha.colorize(:light_magenta)}"
end

report('cask')
report('fonts')
